<!DOCTYPE html>
<html lang="en">

<head>
    <title>Public Transport Router</title>
    <meta charset="UTF-8"> 
    <script src="lib/jquery-1.12.4.js"></script>
    <script src="lib/jquery-ui.js"></script>
    <script src="AutoComplete.js"></script>
    <script src="RoutePlanningScript.js"></script>
    <script src="RailwayMap.js"></script>
    
    <link rel="stylesheet" href="lib/leaflet/leaflet.css"/>
	<script src="lib/leaflet/leaflet.js"></script>

    <link rel="stylesheet" href="lib/jquery-ui.css">
    
    <script src="lib/jquery.timepicker.js"></script>
    <link rel="stylesheet" type="text/css" href="lib/jquery.timepicker.css" />

    <script>
    $(function(){
        $("#header").load("header.html");
        $("#footer").load("footer.html"); 
    });
    </script>

    
</head>

<body>


<header id="header"></header>

<div class="content">

<div class='content-split'>


<div class="journey-contents">
<form autocomplete="off" onsubmit="loadJourneys()">
<table>
<tr>
<td>From</td><td><span class="autocomplete"><input type="text" id="from" name="from"></span></td>
<td>To</td><td><span class="autocomplete"><input type="text" id="to" name="to"></span></td>
</tr>
<tr>
<td>Date</td><td><input type="text" id="depDate" name="depDate"></td>
<td>Time</td><td><input type="text" id="depTime" name="depTime"></td>
</tr>
<tr>
<td></td>
<td><button onclick="loadJourneys()" type="button">Search journeys</button></td>
<td></td>
<td><button onclick="reverseJourneys()" type="button">Reverse</button></td>
</tr>
</table>

</form>



<div id="journeys"></div>
</div>  <!-- Journey-contents-->

<div class='map-container'>
<div id="map" class='map'></div>
</div>


</div> <!--content-split-->


<footer id="footer"></footer>

 <!-- No more HTML elements below, only script-->
 
<script>
"use strict";

/**** Input setup *****/
$( function() {
    $( "#depDate" ).datepicker({dateFormat: "yy-mm-dd"});
    $( "#depDate" ).datepicker("setDate", new Date());
  } );
  
$('#depTime').timepicker({'timeFormat': 'H:i', 'step':5});
$('#depTime').timepicker('setTime', new Date());


var map = initializeMap();

window.setTimeout(function(){
    map.invalidateSize(true);
}, 500);

function suggestStations(val, callback){
    searchStation(val, function(data){
        var arr = [];
        var tags = [];
        for(let i in data){
            arr.push(data[i].location.name);
            tags.push(data[i].location);
        }
        callback(arr, tags);
    });
}

autocomplete(document.getElementById("from"), suggestStations, rerenderStartEnd);
autocomplete(document.getElementById("to"), suggestStations, rerenderStartEnd);

document.getElementById("from").focus();



function htmlToElement(html) {
    let template = document.createElement('template');
    html = html.trim(); // Never return a text node of whitespace as the result
    template.innerHTML = html;
    return template.content.firstChild;
}

function dateHHMM(date){
    return new Date(date).toTimeString().split(' ')[0].substring(0,5);
}

function renderJourney(journey){
    let depTime = dateHHMM(journey.departure.time);
    let arrTime = dateHHMM(journey.arrival.time);
    let totalMinutes = Math.floor(journey.travelTime / 60);
    let minutes =  (totalMinutes % 60);
    if(minutes < 10){
        minutes = "0"+minutes;
    }
    let totalTime = (Math.floor(totalMinutes / 60)) + ":" + minutes;
    let trainTo = journey.segments[0].headsign;
    
    
    
    
    
    
    
    let transfers = journey.transfers == 0 ? "" :
        "(" + journey.transfers + " transfers)";
    
    let headerText = "<div class=journey-header><strong>"+depTime+" > "+arrTime+"</strong>  <span class='weak'>("+ totalTime +" total time)</span> <br /> <span class='weak'>Train to</span> <strong>"+trainTo+"</strong> "+ transfers +"</div>"
    
    var segments = "";
    for(var i in journey.segments){
        var segment = journey.segments[i];
        
        
        segments += "<p><span class='weak'>Take the train with destination </span><strong>"+segment.headsign+"</strong><span class='weak'>, get off in </span><strong>"+segment.arrival.location.name+"</strong> at "+ dateHHMM(segment.arrival.time) +" </p>";
    
    }
    segments    = "<div class='hidden'><div class='journey-content'>"+segments+"</div></div>"
    
    let journeyText = "<div class='journey'>"+headerText+segments+"</div>";
    
    let el = htmlToElement(journeyText);
    el.journeyLayer = createJourneyLayer(journey);
    el.addEventListener('click', function(){
        var contents = el.childNodes[1];
        if(contents.className == "hidden"){
            contents.className = ""; 
            map.addLayer(el.journeyLayer);
        }else{
            contents.className += "hidden";
            map.removeLayer(el.journeyLayer);
        }
    });
    journeys.appendChild(el);
    return el;
}

function renderJourneys(journeys){
    var journeyEl = document.getElementById("journeys");
    while (journeyEl.firstChild) {
        map.removeLayer(journeyEl.firstChild.journeyLayer);
        journeyEl.removeChild(journeyEl.firstChild);
    }

    let firstEl = undefined;
    for(var i in journeys){
        let el = renderJourney(journeys[i]);
        if(firstEl === undefined){
            firstEl = el;
        }
    }
    firstEl.click();
}
    
function onFail(){
    alert("Looking up the journey failed. Perhaps you tried searching a lot in the past of the future?")
}

var startCircle, endCircle;
function rerenderStartEnd(){
    let fromField = document.getElementById("from");
    let fromId = fromField.hiddenValue;
    console.log("Rendering start at ",fromId, fromId);
	    
    if(fromId){
        if(startCircle){
            map.removeLayer(startCircle);
        }
        startCircle = L.circle([fromId.lat, fromId.lon], {
        color: 'green',
        fillColor: '#0f3',
        fillOpacity: 0.5,
        radius: 5000
        });
        startCircle.addTo(map);
    }
    
    let toField = document.getElementById("to");
    let toId = toField.hiddenValue;
    
    if(toId){
        if(endCircle){
            map.removeLayer(endCircle);
        }
        endCircle = L.circle([toId.lat, toId.lon], {
            color: 'red',
            fillColor: '#f03',
            fillOpacity: 0.5,
            radius: 5000
        });
        endCircle.addTo(map);
    }
    
}

function reverseJourneys(){
    let fromField = document.getElementById("from");
    let fromId = fromField.hiddenValue;
    
    let toField = document.getElementById("to");
    let toId = toField.hiddenValue;
    
    var tempValue = fromField.value;
    var tempHV = fromField.hiddenValue;
    
    fromField.value = toField.value;
    fromField.hiddenValue = toField.hiddenValue;
    
    toField.value = tempValue;
    toField.hiddenValue = tempHV;
    
    rerenderStartEnd();
 
}

function loadJourneys(){
    let fromField = document.getElementById("from");
    let fromId = fromField.hiddenValue;
    
    let toField = document.getElementById("to");
    let toId = toField.hiddenValue;

    
    if(fromId === undefined && fromField.value.length > 0){
        // the user only typed, but did not use the autocomplete or tab
        // We search the station and make a guess
        searchStation(fromField.value, function(data){
            fromField.value = data[0].name;
            fromField.hiddenValue = data[0].location;
            rerenderStartEnd();
            loadJourneys();
        });
        
        return;
    }
    
    if(toId === undefined && toField.value.length > 0){
        // the user only typed, but did not use the autocomplete or tab
        // We search the station and make a guess
        searchStation(toField.value, function(data){
            toField.value = data[0].name;
            toField.hiddenValue = data[0].location;
            rerenderStartEnd();
            loadJourneys();
        });
        
        return;
    }
    
    if(fromId === undefined || toId === undefined){
        alert("Please, specify a departure and arrival station. No valid station was found.");
        return;
    }
    
    let depTime = document.getElementById('depDate').value + " "+document.getElementById('depTime').value+'+01:00';
    let date = new Date(depTime).toISOString();
    
    lookupJourney(fromId.id, toId.id, date, 180, renderJourneys, onFail)
    
}


</script>



</body>

</html>
